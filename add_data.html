<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√™m d·ªØ li·ªáu thu·ªëc - Admin</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    main{max-width:800px;margin:20px auto;padding:16px;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);}
    form{display:grid;gap:16px;}
    input,textarea,select{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%;font-family:inherit}
    label{font-weight:600}
    .row{display:grid;gap:8px}
    .btn.primary{background:#2b7cff;color:#fff}
    .preview{margin-top:12px;max-width:200px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#f1f5f9;text-align:left}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-content"><h2>üßæ Th√™m d·ªØ li·ªáu thu·ªëc</h2></div>
  </header>
  <main>
    <form id="drugForm">
      <div class="row">
        <label>T√™n thu·ªëc</label>
        <input id="name" required placeholder="V√≠ d·ª•: Paracetamol">
      </div>
      <div class="row">
        <label>Nh√≥m thu·ªëc</label>
        <input id="category" placeholder="V√≠ d·ª•: Gi·∫£m ƒëau, h·∫° s·ªët">
      </div>
      <div class="row">
        <label>M√¥ t·∫£ (s·∫Ω ch·ªânh b·∫±ng TinyMCE b√™n d∆∞·ªõi)</label>
        <textarea id="description" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt..." style="display:none"></textarea>
      </div>
      <div class="row">
        <label>Th√†nh ph·∫ßn</label>
        <input id="composition" placeholder="V√≠ d·ª•: Paracetamol 500mg/vi√™n">
      </div>
      <div class="row">
        <label>Ch·ªâ ƒë·ªãnh (m·ªói d√≤ng 1 m·ª•c)</label>
        <textarea id="indication" rows="3"></textarea>
      </div>
      <div class="row">
        <label>Ch·ªëng ch·ªâ ƒë·ªãnh (m·ªói d√≤ng 1 m·ª•c)</label>
        <textarea id="contraindication" rows="3"></textarea>
      </div>
      <div class="row">
        <label>T∆∞∆°ng t√°c thu·ªëc</label>
        <textarea id="interaction" rows="3" style="display:none"></textarea>
      </div>
      <div class="row">
        <label>Ph√°c ƒë·ªì ƒëi·ªÅu tr·ªã</label>
        <textarea id="treatment" rows="3" style="display:none"></textarea>
      </div>

      <div class="row">
        <label>Danh s√°ch h√¨nh ·∫£nh (m·ªói d√≤ng 1 URL) - s·∫Ω ch·ªânh b·∫±ng TinyMCE</label>
        <textarea id="images" rows="3" style="display:none"></textarea>
      </div>

      <div class="row">
        <label>·∫¢nh thu·ªëc (upload ho·∫∑c d√°n link)</label>
        <input type="file" id="imageFile" accept="image/*">
        <input id="imageUrl" placeholder="Ho·∫∑c d√°n URL ·∫£nh c√≥ s·∫µn">
        <img id="preview" class="preview" hidden>
      </div>

      <div class="row">
        <label>Link h√¨nh n·ªÅn card (t√πy ch·ªçn)</label>
        <input id="bgImage" placeholder="URL h√¨nh n·ªÅn th·∫ª card (hi·ªÉn th·ªã ·ªü trang ch·ªß)">
      </div>

      <button type="submit" class="btn primary">üíæ L∆∞u thu·ªëc v√†o Database</button>
    </form>

    <section id="drugList">
      <h3>üìö Danh s√°ch thu·ªëc hi·ªán c√≥</h3>
      <table id="drugTable">
        <thead><tr><th>T√™n</th><th>Nh√≥m</th><th>Slug</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- TinyMCE CDN -->
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
    import { ref as dbRef, set, get, child } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';
    import { ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js';
    
    // Utility functions
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDqdWux9ISGgG9dJIz_BuUTg2akiUYM14c",
      authDomain: "tracuuyte-7061a.firebaseapp.com",
      databaseURL: "https://tracuuyte-7061a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tracuuyte-7061a",
      storageBucket: "tracuuyte-7061a.firebasestorage.app",
      messagingSenderId: "837205769673",
      appId: "1:837205769673:web:45371c7b8f5efce4b1fc18",
      measurementId: "G-69TJE53D20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const form = document.getElementById('drugForm');
    const preview = document.getElementById('preview');
    const imageFile = document.getElementById('imageFile');
    const imageUrl = document.getElementById('imageUrl');
    const tableBody = document.querySelector('#drugTable tbody');
    const bgImageInput = document.getElementById('bgImage');
    const headerTitle = document.querySelector('.header-content h2');

    // Rich editor area and section chooser UI
    const editorHost = document.createElement('section');
    editorHost.style.marginTop = '12px';
    editorHost.innerHTML = `
      <div class="row">
        <label>Ch·ªçn ph·∫ßn c·∫ßn ch·ªânh s·ª≠a b·∫±ng TinyMCE</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button type="button" class="btn" data-sec="overview">T·ªïng quan</button>
          <button type="button" class="btn" data-sec="interaction">T∆∞∆°ng t√°c</button>
          <button type="button" class="btn" data-sec="treatment">Ph√°c ƒë·ªì</button>
          <button type="button" class="btn" data-sec="images">H√¨nh ·∫£nh</button>
        </div>
      </div>
      <textarea id="richEditor" rows="10"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button type="button" class="btn primary" id="applyEditorBtn">√Åp d·ª•ng v√†o ph·∫ßn ƒëang ch·ªçn</button>
      </div>
    `;
    form.insertBefore(editorHost, form.querySelector('button[type="submit"]').parentElement);

    let currentSection = 'overview';

    function htmlFromLines(lines){
      if(!Array.isArray(lines)) return '';
      if(!lines.length) return '';
      return `<ul>` + lines.map(x=>`<li>${x}</li>`).join('') + `</ul>`;
    }

    function linesFromHtml(html){
      const tmp = document.createElement('div');
      tmp.innerHTML = html || '';
      const lis = [...tmp.querySelectorAll('li')];
      if(lis.length) return lis.map(li=>li.textContent.trim()).filter(Boolean);
      // Fallback: split by newline
      return (tmp.textContent||'').split('\n').map(s=>s.trim()).filter(Boolean);
    }

    function loadSectionToEditor(section){
      currentSection = section;
      let content = '';
      if(section==='overview'){
        content = form.description.value || '';
      }else if(section==='interaction'){
        content = htmlFromLines(form.interaction.value.split('\n').filter(Boolean));
      }else if(section==='treatment'){
        content = htmlFromLines(form.treatment.value.split('\n').filter(Boolean));
      }else if(section==='images'){
        // show as list of URLs
        content = htmlFromLines((form.images?.value||'').split('\n').filter(Boolean));
      }
      tinymce.get('richEditor')?.setContent(content || '');
    }

    function applyEditorToSection(){
      const html = tinymce.get('richEditor')?.getContent() || '';
      if(currentSection==='overview'){
        form.description.value = html;
      }else if(currentSection==='interaction'){
        form.interaction.value = linesFromHtml(html).join('\n');
      }else if(currentSection==='treatment'){
        form.treatment.value = linesFromHtml(html).join('\n');
      }else if(currentSection==='images'){
        const urls = linesFromHtml(html);
        if(!form.images){
          const ta = document.getElementById('images');
          form.appendChild(ta);
        }
        document.getElementById('images').value = urls.join('\n');
      }
      alert('ƒê√£ √°p d·ª•ng n·ªôi dung cho ph·∫ßn: ' + currentSection);
    }

    // Init TinyMCE
    tinymce.init({
      selector:'#richEditor',
      menubar:false,
      plugins:'lists link autolink image table code fullscreen',
      toolbar:'undo redo | bold italic underline | bullist numlist | link image | table | removeformat | code fullscreen',
      height: 320
    }).then(()=>{
      loadSectionToEditor('overview');
    });

    editorHost.querySelectorAll('button[data-sec]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        applyEditorToSection();
        loadSectionToEditor(btn.dataset.sec);
      });
    });
    editorHost.querySelector('#applyEditorBtn').addEventListener('click', applyEditorToSection);

    const editingSlug = getQueryParam('slug');

    imageFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(f){ preview.src = URL.createObjectURL(f); preview.hidden = false; }
    });

    function toSlug(str){
      return str.toLowerCase().normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/ƒë/g,'d')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }

    async function uploadImageIfNeeded(file){
      if(!file) return null;
      const fileRef = sRef(storage, 'images/'+file.name);
      const snap = await uploadBytes(fileRef, file);
      return await getDownloadURL(snap.ref);
    }

    async function loadDrugList(){
      const snap = await get(child(dbRef(db), 'drug_names'));
      tableBody.innerHTML = '';
      if(!snap.exists()) return;
      Object.entries(snap.val()).forEach(([slug, v])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><a href=\"./add_data.html?slug=${slug}\">${v.name}</a></td><td>${v.category||''}</td><td>${slug}</td>`;
        tr.addEventListener('click', (e)=>{
          if(e.target.closest('a')) return;
          window.location.href = `./add_data.html?slug=${slug}`;
        });
        tableBody.appendChild(tr);
      });
    }

    async function loadForEdit(slug){
      if(!slug) return;
      const snap = await get(child(dbRef(db), `drugs/${slug}`));
      if(!snap.exists()) return;
      const d = snap.val();
      form.name.value = d.name || '';
      form.category.value = d.category || '';
      const desc = d.overview?.description || '';
      form.description.value = desc; // keep HTML for TinyMCE
      form.composition.value = d.overview?.composition || '';
      form.indication.value = Array.isArray(d.overview?.indication)? d.overview.indication.join('\n') : '';
      form.contraindication.value = Array.isArray(d.overview?.contraindication)? d.overview.contraindication.join('\n') : '';
      form.interaction.value = Array.isArray(d.interaction)? d.interaction.join('\n') : '';
      form.treatment.value = Array.isArray(d.treatment)? d.treatment.join('\n') : '';
      const imagesArr = Array.isArray(d.images)? d.images : [];
      const imagesTa = document.getElementById('images');
      imagesTa.value = imagesArr.join('\n');
      if(d.image){ preview.src = d.image; preview.hidden = false; imageUrl.value = d.image; }
      if(d.bgImage){ bgImageInput.value = d.bgImage; }
      headerTitle && (headerTitle.textContent = 'üßæ Ch·ªânh s·ª≠a thu·ªëc');
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn && (submitBtn.textContent = 'üíæ C·∫≠p nh·∫≠t thu·ªëc');
      document.title = `Ch·ªânh s·ª≠a: ${d.name} - Admin`;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = form.name.value.trim();
      const slug = editingSlug || toSlug(name);
      const category = form.category.value.trim();
      // Ensure editor content saved back
      applyEditorToSection();
      const description = form.description.value.trim();
      const composition = form.composition.value.trim();
      const indication = form.indication.value.split('\n').filter(Boolean);
      const contraindication = form.contraindication.value.split('\n').filter(Boolean);
      const interaction = form.interaction.value.split('\n').filter(Boolean);
      const treatment = form.treatment.value.split('\n').filter(Boolean);
      const images = (document.getElementById('images').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
      const bgImage = bgImageInput.value.trim();

      let img = imageUrl.value.trim();
      if(imageFile.files[0]) img = await uploadImageIfNeeded(imageFile.files[0]);

      if(!name){ alert('Vui l√≤ng nh·∫≠p t√™n thu·ªëc'); return; }

      const drugData = {
        name, category, image: img||'',
        overview:{
          description: description || '',
          composition, indication, contraindication
        },
        interaction, treatment,
        images,
        bgImage,
        keywords:[slug, name.toLowerCase()]
      };

      await set(dbRef(db, `drugs/${slug}`), drugData);
      await set(dbRef(db, `drug_names/${slug}`), { name, category, image: img||'', bgImage });

      alert('‚úÖ ƒê√£ l∆∞u thu·ªëc: ' + name);
      form.reset(); preview.hidden = true;
      loadDrugList();
      
      // Redirect to index page to show updated data
      setTimeout(() => {
        window.location.href = './index.html?fromAdmin=true';
      }, 1000);
    });

    loadDrugList();
    if(editingSlug){
      loadForEdit(editingSlug);
    }
  </script>
</body>
</html>
