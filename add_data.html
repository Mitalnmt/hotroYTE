  <!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√™m d·ªØ li·ªáu thu·ªëc - Admin</title>
  <!-- <link rel="stylesheet" href="css/style.css"> -->
  <style>
    main{max-width:800px;margin:20px auto;padding:16px;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);}
    form{display:grid;gap:16px;}
    input,textarea,select{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%;font-family:inherit}
    label{font-weight:600}
    .row{display:grid;gap:8px}
    .btn.primary{background:#2b7cff;color:#fff}
    .preview{margin-top:12px;max-width:200px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#f1f5f9;text-align:left}
    
    /* Tag Modal Styles */
    .tag-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .tag-modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .tag-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .tag-modal-close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .tag-modal-close:hover { color: #000; }
    .tag-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .tag-option {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 20px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 500;
    }
    .tag-option:hover {
      border-color: #2b7cff;
      background: #f0f8ff;
    }
    .tag-option.selected {
      background: #2b7cff;
      color: white;
      border-color: #2b7cff;
    }
    .add-new-tag {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .add-new-tag input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    /* Drag and Drop Styles */
    .tag.draggable {
      cursor: grab;
      transition: all 0.3s ease;
    }
    .tag.draggable:active {
      cursor: grabbing;
    }
    .tag.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .trash-bin {
      width: 100%;
      height: 60px;
      border: 2px dashed #ff4444;
      border-radius: 8px;
      background: #ffe6e6;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      transition: all 0.3s ease;
      color: #ff4444;
      font-weight: bold;
    }
    .trash-bin.drag-over {
      background: #ffcccc;
      border-color: #ff0000;
      transform: scale(1.02);
    }
    .trash-bin-icon {
      font-size: 24px;
      margin-right: 8px;
    }
    
    /* Select Tags Button */
    #selectTagsBtn:hover {
      background: #45a049 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    
    #selectTagsBtn:active {
      transform: translateY(0);
    }
    
    /* Save Button Styles */
    button[type="submit"]:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6) !important;
    }
    
    button[type="submit"]:active {
      transform: translateY(-1px) !important;
    }
    
    #newDrugBtn:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6) !important;
    }
    
    #newDrugBtn:active {
      transform: translateY(-1px) !important;
    }
    
    /* Loading state for buttons */
    button:disabled {
      opacity: 0.7 !important;
      cursor: not-allowed !important;
      transform: none !important;
    }
    
    /* Modal Button Styles */
    #cancelTagsBtn:hover {
      background: #d32f2f !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
    }
    
    #confirmTagsBtn:hover {
      background: #45a049 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4) !important;
    }
    
    #cancelTagsBtn:active, #confirmTagsBtn:active {
      transform: translateY(0);
    }
    
    /* Add New Tag Button */
    #addNewTagBtn:hover {
      background: #1976D2 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4) !important;
    }
    
    #addNewTagBtn:active {
      transform: translateY(0);
    }
    
    /* Delete button styles */
    #deleteDrugBtn:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 8px 25px rgba(255, 68, 68, 0.6) !important;
    }
    
    #deleteDrugBtn:active {
      transform: translateY(-1px) !important;
    }
    
    /* Input focus effect */
    #newTagInput:focus {
      outline: none;
      border-color: #2196F3 !important;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    
    /* Header styles */
    .app-header {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 0;
      margin-bottom: 20px;
    }
    
    .header-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 16px;
      display: flex;
      align-items: center;
    }
    
    .back-btn:hover {
      background: #3367d6 !important;
      transform: translateY(-1px);
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 400px;
      word-wrap: break-word;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }
    
    .notification.info {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-content">
      <a href="index.html" class="back-btn" style="background: #4285f4; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 14px; transition: all 0.3s ease; margin-right: 15px;">
        ‚Üê Trang ch·ªß
      </a>
      <h2>üßæ Th√™m d·ªØ li·ªáu thu·ªëc</h2>
    </div>
  </header>
  <main>
    <form id="drugForm">
      <div class="row">
        <label>T√™n thu·ªëc</label>
        <input id="name" required placeholder="V√≠ d·ª•: Paracetamol">
      </div>
      <div class="row">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <label style="margin: 0; flex-shrink: 0;">Tags thu·ªëc</label>
          <button type="button" id="selectTagsBtn" class="btn primary" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); border: none; padding: 12px 20px; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3); font-size: 14px;">
            üè∑Ô∏è Ch·ªçn tags
          </button>
        </div>
        <div id="tagsContainer" style="min-height: 70px; border: 2px dashed #e0e0e0; border-radius: 8px; padding: 15px; background: #fafafa; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
          <span id="emptyTagsMessage" style="color: #999; font-style: italic;">Ch∆∞a c√≥ tag n√†o ƒë∆∞·ª£c ch·ªçn</span>
        </div>
      </div>
      <div class="row">
        <label>M√¥ t·∫£ chi ti·∫øt</label>
        <textarea id="description" rows="6" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ thu·ªëc..."></textarea>
      </div>
      <div class="row">
        <label>Th√†nh ph·∫ßn (m·ªói d√≤ng 1 th√†nh ph·∫ßn)</label>
        <textarea id="composition" rows="3" placeholder="V√≠ d·ª•:&#10;Paracetamol : 500mg&#10;Caffeine : 65mg&#10;T√° d∆∞·ª£c : v·ª´a ƒë·ªß"></textarea>
      </div>
      <div class="row">
        <label>Ch·ªâ ƒë·ªãnh (m·ªói d√≤ng 1 m·ª•c)</label>
        <textarea id="indication" rows="3"></textarea>
      </div>
      <div class="row">
        <label>Ch·ªëng ch·ªâ ƒë·ªãnh (m·ªói d√≤ng 1 m·ª•c)</label>
        <textarea id="contraindication" rows="3"></textarea>
      </div>

      <div class="row">
        <label>·∫¢nh thu·ªëc (upload ho·∫∑c d√°n link)</label>
        <input type="file" id="imageFile" accept="image/*">
        <input id="imageUrl" placeholder="Ho·∫∑c d√°n URL ·∫£nh c√≥ s·∫µn">
        <img id="preview" class="preview" hidden>
      </div>


      <div style="display: flex; justify-content: center; gap: 15px; margin-top: 30px; padding: 20px 0;">
        <button type="submit" class="btn primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 15px 30px; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); min-width: 200px;">
          üíæ L∆∞u thu·ªëc v√†o Database
        </button>
        <button type="button" id="newDrugBtn" class="btn" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; padding: 15px 30px; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4); min-width: 180px;">
          ‚ûï Th√™m thu·ªëc m·ªõi
        </button>
        <button type="button" id="deleteDrugBtn" class="btn" style="display: none; background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); border: none; padding: 15px 30px; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4); min-width: 180px;">
          üóëÔ∏è X√≥a thu·ªëc
        </button>
      </div>
    </form>

    <section id="drugList">
      <h3>üìö Danh s√°ch thu·ªëc hi·ªán c√≥</h3>
      <table id="drugTable">
        <thead><tr><th>T√™n</th><th>Tags</th><th>Slug</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Tag Selection Modal -->
  <div id="tagModal" class="tag-modal">
    <div class="tag-modal-content">
      <div class="tag-modal-header">
        <h3>üè∑Ô∏è Ch·ªçn Tags</h3>
        <span class="tag-modal-close">&times;</span>
      </div>
      
      <div class="add-new-tag">
        <input type="text" id="newTagInput" placeholder="Nh·∫≠p tag m·ªõi..." style="flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease;">
        <button type="button" id="addNewTagBtn" class="btn" style="background: #2196F3; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);">
          ‚ûï Th√™m
        </button>
      </div>
      
      <div id="tagGrid" class="tag-grid">
        <!-- Available tags will be loaded here -->
      </div>
      
      <div class="trash-bin" id="trashBin">
        <span class="trash-bin-icon">üóëÔ∏è</span>
        <span>K√©o tag v√†o ƒë√¢y ƒë·ªÉ x√≥a</span>
      </div>
      
      <div class="modal-actions">
        <button type="button" id="cancelTagsBtn" class="btn" style="background: #f44336; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);">
          ‚ùå H·ªßy
        </button>
        <button type="button" id="confirmTagsBtn" class="btn primary" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);">
          ‚úÖ X√°c nh·∫≠n
        </button>
      </div>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
    import { ref as dbRef, set, get, child } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';
    import { ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js';
    
    // Utility functions
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDqdWux9ISGgG9dJIz_BuUTg2akiUYM14c",
      authDomain: "tracuuyte-7061a.firebaseapp.com",
      databaseURL: "https://tracuuyte-7061a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tracuuyte-7061a",
      storageBucket: "tracuuyte-7061a.firebasestorage.app",
      messagingSenderId: "837205769673",
      appId: "1:837205769673:web:45371c7b8f5efce4b1fc18",
      measurementId: "G-69TJE53D20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const form = document.getElementById('drugForm');
    const preview = document.getElementById('preview');
    const imageFile = document.getElementById('imageFile');
    const imageUrl = document.getElementById('imageUrl');
    const tableBody = document.querySelector('#drugTable tbody');
    const bgImageInput = document.getElementById('bgImage');
    const headerTitle = document.querySelector('.header-content h2');


    // Tags management
    let selectedTags = [];
    let availableTags = [];
    let tempSelectedTags = [];
    
    const tagsContainer = document.getElementById('tagsContainer');
    const selectTagsBtn = document.getElementById('selectTagsBtn');
    const tagModal = document.getElementById('tagModal');
    const tagGrid = document.getElementById('tagGrid');
    const newTagInput = document.getElementById('newTagInput');
    const addNewTagBtn = document.getElementById('addNewTagBtn');
    const confirmTagsBtn = document.getElementById('confirmTagsBtn');
    const cancelTagsBtn = document.getElementById('cancelTagsBtn');
    const modalClose = document.querySelector('.tag-modal-close');
    const newDrugBtn = document.getElementById('newDrugBtn');
    const deleteDrugBtn = document.getElementById('deleteDrugBtn');

    function createTagElement(tag, isDraggable = false) {
      const tagEl = document.createElement('span');
      tagEl.className = 'tag';
      tagEl.style.cssText = 'background: #e3f2fd; color: #1976d2; padding: 8px 12px; border-radius: 20px; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px; min-height: 32px;';
      
      if (isDraggable) {
        tagEl.classList.add('draggable');
        tagEl.draggable = true;
        tagEl.dataset.tag = tag;
        
        tagEl.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', tag);
          tagEl.classList.add('dragging');
        });
        
        tagEl.addEventListener('dragend', () => {
          tagEl.classList.remove('dragging');
        });
      } else {
        tagEl.innerHTML = `${tag} <span style="cursor: pointer; font-weight: bold; font-size: 16px; margin-left: 4px;" onclick="removeTag('${tag}')">√ó</span>`;
      }
      
      return tagEl;
    }

    function removeTag(tag) {
      selectedTags = selectedTags.filter(t => t !== tag);
      renderSelectedTags();
    }

    function renderSelectedTags() {
      tagsContainer.innerHTML = '';
      
      if (selectedTags.length === 0) {
        const emptyMsg = document.createElement('span');
        emptyMsg.id = 'emptyTagsMessage';
        emptyMsg.style.cssText = 'color: #999; font-style: italic;';
        emptyMsg.textContent = 'Ch∆∞a c√≥ tag n√†o ƒë∆∞·ª£c ch·ªçn';
        tagsContainer.appendChild(emptyMsg);
      } else {
        selectedTags.forEach(tag => {
          tagsContainer.appendChild(createTagElement(tag));
        });
      }
    }

    // Make functions globally accessible
    window.removeTag = removeTag;
    window.editDrug = editDrug;

    // Delete drug function
    async function deleteDrug() {
      const currentSlug = window.currentEditingSlug;
      if (!currentSlug) {
        showNotification('‚ùå Kh√¥ng c√≥ thu·ªëc n√†o ƒë·ªÉ x√≥a', 'error');
        return;
      }

      // Show confirmation dialog
      const drugName = form.name.value || 'thu·ªëc n√†y';
      const confirmed = confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a "${drugName}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`);
      
      if (!confirmed) return;

      try {
        // Show loading state
        deleteDrugBtn.disabled = true;
        deleteDrugBtn.textContent = '‚è≥ ƒêang x√≥a...';

        // Delete from both collections
        await set(dbRef(db, `drugs/${currentSlug}`), null);
        await set(dbRef(db, `drug_names/${currentSlug}`), null);

        // Show success notification
        showNotification(`‚úÖ ƒê√£ x√≥a thu·ªëc: ${drugName}`, 'success');

        // Reset form to add new mode
        form.reset();
        preview.hidden = true;
        selectedTags = [];
        renderSelectedTags();

        // Reset UI to add new mode
        headerTitle && (headerTitle.textContent = 'üßæ Th√™m d·ªØ li·ªáu thu·ªëc');
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn && (submitBtn.textContent = 'üíæ L∆∞u thu·ªëc v√†o Database');
        newDrugBtn && (newDrugBtn.style.display = 'none');
        deleteDrugBtn && (deleteDrugBtn.style.display = 'none');
        document.title = 'Th√™m d·ªØ li·ªáu thu·ªëc - Admin';

        // Clear editing state
        window.currentEditingSlug = null;

        // Reload drug list
        await loadDrugList();

      } catch (error) {
        console.error('Error deleting drug:', error);
        showNotification('‚ùå L·ªói khi x√≥a thu·ªëc: ' + error.message, 'error');
      } finally {
        deleteDrugBtn.disabled = false;
        deleteDrugBtn.textContent = 'üóëÔ∏è X√≥a thu·ªëc';
      }
    }

    // Notification function
    function showNotification(message, type = 'info') {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      });

      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Trigger animation
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    async function loadAvailableTags() {
      try {
        const snap = await get(child(dbRef(db), 'tags'));
        if (snap.exists()) {
          availableTags = Object.keys(snap.val()).sort();
        } else {
          availableTags = [];
        }
        renderTagGrid();
      } catch (error) {
        console.error('Error loading tags:', error);
        availableTags = [];
      }
    }

    function renderTagGrid() {
      tagGrid.innerHTML = '';
      availableTags.forEach(tag => {
        const tagElement = createTagElement(tag, true);
        tagElement.textContent = tag;
        
        if (tempSelectedTags.includes(tag)) {
          tagElement.style.background = '#2b7cff';
          tagElement.style.color = 'white';
        }
        
        tagElement.addEventListener('click', () => {
          if (tempSelectedTags.includes(tag)) {
            tempSelectedTags = tempSelectedTags.filter(t => t !== tag);
            tagElement.style.background = '#e3f2fd';
            tagElement.style.color = '#1976d2';
          } else {
            tempSelectedTags.push(tag);
            tagElement.style.background = '#2b7cff';
            tagElement.style.color = 'white';
          }
        });
        
        tagGrid.appendChild(tagElement);
      });
    }

    function openTagModal() {
      tempSelectedTags = [...selectedTags];
      renderTagGrid();
      tagModal.style.display = 'block';
    }

    function closeTagModal() {
      tagModal.style.display = 'none';
    }

    function confirmTagSelection() {
      selectedTags = [...tempSelectedTags];
      renderSelectedTags();
      closeTagModal();
    }

    async function addNewTag() {
      const newTag = newTagInput.value.trim();
      if (newTag && !availableTags.includes(newTag)) {
        availableTags.push(newTag);
        availableTags.sort();
        await set(dbRef(db, `tags/${newTag}`), true);
        renderTagGrid();
        newTagInput.value = '';
      }
    }

    // Event listeners
    selectTagsBtn.addEventListener('click', openTagModal);
    modalClose.addEventListener('click', closeTagModal);
    cancelTagsBtn.addEventListener('click', closeTagModal);
    confirmTagsBtn.addEventListener('click', confirmTagSelection);
    addNewTagBtn.addEventListener('click', addNewTag);
    deleteDrugBtn.addEventListener('click', deleteDrug);

    newTagInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addNewTag();
      }
    });

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === tagModal) {
        closeTagModal();
      }
    });

    // Trash bin drag and drop functionality
    const trashBin = document.getElementById('trashBin');
    
    trashBin.addEventListener('dragover', (e) => {
      e.preventDefault();
      trashBin.classList.add('drag-over');
    });
    
    trashBin.addEventListener('dragleave', () => {
      trashBin.classList.remove('drag-over');
    });
    
    trashBin.addEventListener('drop', (e) => {
      e.preventDefault();
      trashBin.classList.remove('drag-over');
      
      const tagToDelete = e.dataTransfer.getData('text/plain');
      if (tagToDelete && availableTags.includes(tagToDelete)) {
        // Remove from available tags
        availableTags = availableTags.filter(tag => tag !== tagToDelete);
        
        // Remove from temp selected tags if selected
        tempSelectedTags = tempSelectedTags.filter(tag => tag !== tagToDelete);
        
        // Remove from database
        set(dbRef(db, `tags/${tagToDelete}`), null);
        
        // Re-render the grid
        renderTagGrid();
        
        console.log(`Tag "${tagToDelete}" ƒë√£ ƒë∆∞·ª£c x√≥a`);
      }
    });


    const editingSlug = getQueryParam('slug');

    imageFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(f){ preview.src = URL.createObjectURL(f); preview.hidden = false; }
    });

    function toSlug(str){
      return str.toLowerCase().normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/ƒë/g,'d')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }

    async function uploadImageIfNeeded(file){
      if(!file) return null;
      try {
        // Create unique filename to avoid conflicts
        const timestamp = Date.now();
        const fileExtension = file.name.split('.').pop();
        const uniqueFileName = `drug_${timestamp}.${fileExtension}`;
        
        const fileRef = sRef(storage, `drug_images/${uniqueFileName}`);
        const snap = await uploadBytes(fileRef, file);
        const downloadURL = await getDownloadURL(snap.ref);
        
        console.log('Image uploaded successfully:', downloadURL);
        return downloadURL;
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('‚ùå L·ªói khi upload ·∫£nh: ' + error.message);
        return null;
      }
    }

    async function loadDrugList(){
      const snap = await get(child(dbRef(db), 'drug_names'));
      tableBody.innerHTML = '';
      if(!snap.exists()) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ thu·ªëc n√†o ƒë∆∞·ª£c th√™m</td></tr>';
        return;
      }
      
      const drugs = Object.entries(snap.val());
      if (drugs.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ thu·ªëc n√†o ƒë∆∞·ª£c th√™m</td></tr>';
        return;
      }
      
      drugs.forEach(([slug, v])=>{
        const tr = document.createElement('tr');
        const tagsDisplay = Array.isArray(v.tags) ? v.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; margin: 2px; display: inline-block;">${tag}</span>`).join(' ') : '';
        tr.innerHTML = `
          <td>
            <a href="#" onclick="editDrug('${slug}'); return false;" style="color: #2b7cff; text-decoration: none; font-weight: 500;">
              ${v.name}
            </a>
          </td>
          <td>${tagsDisplay}</td>
          <td style="font-family: monospace; font-size: 12px; color: #666;">${slug}</td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', (e)=>{
          if(e.target.closest('a')) return;
          editDrug(slug);
        });
        tableBody.appendChild(tr);
      });
    }

    async function editDrug(slug) {
      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth' });
      
      // Show loading state
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '‚è≥ ƒêang t·∫£i...';
      submitBtn.disabled = true;
      
      try {
        await loadForEdit(slug);
        
        // Show success message
        const editMsg = document.createElement('div');
        editMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #2196F3; color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        editMsg.textContent = `üìù ƒê√£ t·∫£i d·ªØ li·ªáu thu·ªëc ƒë·ªÉ ch·ªânh s·ª≠a`;
        document.body.appendChild(editMsg);
        
        setTimeout(() => {
          if (editMsg.parentNode) {
            editMsg.parentNode.removeChild(editMsg);
          }
        }, 3000);
        
      } catch (error) {
        console.error('Error loading drug for edit:', error);
        showNotification('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu thu·ªëc', 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function loadForEdit(slug){
      if(!slug) return;
      const snap = await get(child(dbRef(db), `drugs/${slug}`));
      if(!snap.exists()) {
        showNotification('‚ùå Kh√¥ng t√¨m th·∫•y thu·ªëc n√†y', 'error');
        return;
      }
      
      const d = snap.val();
      
      // Load basic info
      form.name.value = d.name || '';
      
      // Load tags
      selectedTags = Array.isArray(d.tags) ? d.tags : [];
      renderSelectedTags();
      
      // Load description and details
      const desc = d.overview?.description || '';
      form.description.value = desc;
      
      // Load composition with proper format
      if (Array.isArray(d.overview?.composition)) {
        form.composition.value = d.overview.composition.map(comp => {
          if (typeof comp === 'object' && comp.name && comp.amount) {
            return `${comp.name} : ${comp.amount}`;
          }
          return comp;
        }).join('\n');
      } else {
        form.composition.value = '';
      }
      
      form.indication.value = Array.isArray(d.overview?.indication)? d.overview.indication.join('\n') : '';
      form.contraindication.value = Array.isArray(d.overview?.contraindication)? d.overview.contraindication.join('\n') : '';
      
      // Load image
      if(d.image){ 
        preview.src = d.image; 
        preview.hidden = false; 
        imageUrl.value = d.image; 
      } else {
        preview.hidden = true;
        imageUrl.value = '';
      }
      
      // Update UI for edit mode
      headerTitle && (headerTitle.textContent = `üßæ Ch·ªânh s·ª≠a: ${d.name}`);
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn && (submitBtn.textContent = 'üíæ C·∫≠p nh·∫≠t thu·ªëc');
      newDrugBtn && (newDrugBtn.style.display = 'inline-block');
      deleteDrugBtn && (deleteDrugBtn.style.display = 'inline-block');
      document.title = `Ch·ªânh s·ª≠a: ${d.name} - Admin`;
      
      // Store current editing slug
      window.currentEditingSlug = slug;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = form.name.value.trim();
      const slug = editingSlug || window.currentEditingSlug || toSlug(name);
      
      const description = form.description.value.trim();
      
      // Parse composition with format "Name : Amount"
      const compositionText = form.composition.value.trim();
      const composition = compositionText.split('\n')
        .map(line => {
          const parts = line.split(':').map(p => p.trim());
          if (parts.length >= 2) {
            return { name: parts[0], amount: parts.slice(1).join(':') };
          }
          return null;
        })
        .filter(item => item !== null && item.name && item.amount);
      
      const indication = form.indication.value.split('\n').filter(Boolean);
      const contraindication = form.contraindication.value.split('\n').filter(Boolean);

      let img = imageUrl.value.trim();
      
      // Handle image upload
      if(imageFile.files[0]) {
        console.log('Uploading image file...');
        const uploadedImg = await uploadImageIfNeeded(imageFile.files[0]);
        if(uploadedImg) {
          img = uploadedImg;
          console.log('Image uploaded successfully:', img);
        } else {
          showNotification('‚ùå Kh√¥ng th·ªÉ upload ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
          return;
        }
      }

      if(!name){ showNotification('Vui l√≤ng nh·∫≠p t√™n thu·ªëc', 'error'); return; }
      if(selectedTags.length === 0){ showNotification('Vui l√≤ng th√™m √≠t nh·∫•t 1 tag', 'error'); return; }
      
      console.log('Saving drug with image:', img);

      const drugData = {
        name, 
        tags: selectedTags,
        image: img||'',
        overview:{
          description: description || '',
          composition, indication, contraindication
        },
        keywords:[slug, name.toLowerCase(), ...selectedTags]
      };

      // Save tags to database for future search
      for(const tag of selectedTags) {
        await set(dbRef(db, `tags/${tag}`), true);
      }

      try {
        console.log('Saving to drugs collection:', drugData);
        await set(dbRef(db, `drugs/${slug}`), drugData);
        
        console.log('Saving to drug_names collection:', { name, tags: selectedTags, image: img||'', description, composition, indication, contraindication });
        await set(dbRef(db, `drug_names/${slug}`), { name, tags: selectedTags, image: img||'', description, composition, indication, contraindication });
        
        console.log('Drug saved successfully to database');
        
        // Show success notification
        showNotification('‚úÖ ƒê√£ l∆∞u thu·ªëc: ' + name, 'success');
      } catch (error) {
        console.error('Error saving to database:', error);
        showNotification('‚ùå L·ªói khi l∆∞u v√†o database: ' + error.message, 'error');
        return;
      }
      
      // Reset form to add new mode
      form.reset(); 
      preview.hidden = true;
      selectedTags = [];
      renderSelectedTags();
      
      // Reset UI to add new mode
      headerTitle && (headerTitle.textContent = 'üßæ Th√™m d·ªØ li·ªáu thu·ªëc');
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn && (submitBtn.textContent = 'üíæ L∆∞u thu·ªëc v√†o Database');
      newDrugBtn && (newDrugBtn.style.display = 'none');
      deleteDrugBtn && (deleteDrugBtn.style.display = 'none');
      document.title = 'Th√™m d·ªØ li·ªáu thu·ªëc - Admin';
      
      // Clear editing state
      window.currentEditingSlug = null;
      
      // Reload drug list and available tags
      await loadDrugList();
      await loadAvailableTags();
      
    });

    // Initialize
    loadAvailableTags();
    loadDrugList();
    if(editingSlug){
      loadForEdit(editingSlug);
    }
  </script>
</body>
</html>
