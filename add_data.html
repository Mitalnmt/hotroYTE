<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√™m d·ªØ li·ªáu thu·ªëc - Admin</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    main{max-width:800px;margin:20px auto;padding:16px;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);}
    form{display:grid;gap:16px;}
    input,textarea,select{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%;font-family:inherit}
    label{font-weight:600}
    .row{display:grid;gap:8px}
    .btn.primary{background:#2b7cff;color:#fff}
    .preview{margin-top:12px;max-width:200px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#f1f5f9;text-align:left}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-content"><h2>üßæ Th√™m d·ªØ li·ªáu thu·ªëc</h2></div>
  </header>
  <main>
    <form id="drugForm">
      <div class="row">
        <label>T√™n thu·ªëc</label>
        <input id="name" required placeholder="V√≠ d·ª•: Paracetamol">
      </div>
      <div class="row">
        <label>Tags thu·ªëc</label>
        <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
          <!-- Tags will be added here dynamically -->
        </div>
        <div style="display: flex; gap: 8px;">
          <input id="newTagInput" placeholder="Nh·∫≠p tag m·ªõi..." style="flex: 1;">
          <button type="button" id="addTagBtn" class="btn">+ Th√™m tag</button>
        </div>
      </div>
      <div class="row">
        <label>M√¥ t·∫£ (s·∫Ω ch·ªânh b·∫±ng TinyMCE b√™n d∆∞·ªõi)</label>
        <textarea id="description" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt..." style="display:none"></textarea>
      </div>
      <div class="row">
        <label>Th√†nh ph·∫ßn</label>
        <input id="composition" placeholder="V√≠ d·ª•: Paracetamol 500mg/vi√™n">
      </div>
      <div class="row">
        <label>Ch·ªâ ƒë·ªãnh (m·ªói d√≤ng 1 m·ª•c)</label>
        <textarea id="indication" rows="3"></textarea>
      </div>
      <div class="row">
        <label>Ch·ªëng ch·ªâ ƒë·ªãnh (m·ªói d√≤ng 1 m·ª•c)</label>
        <textarea id="contraindication" rows="3"></textarea>
      </div>

      <div class="row">
        <label>·∫¢nh thu·ªëc (upload ho·∫∑c d√°n link)</label>
        <input type="file" id="imageFile" accept="image/*">
        <input id="imageUrl" placeholder="Ho·∫∑c d√°n URL ·∫£nh c√≥ s·∫µn">
        <img id="preview" class="preview" hidden>
      </div>


      <button type="submit" class="btn primary">üíæ L∆∞u thu·ªëc v√†o Database</button>
    </form>

    <section id="drugList">
      <h3>üìö Danh s√°ch thu·ªëc hi·ªán c√≥</h3>
      <table id="drugTable">
        <thead><tr><th>T√™n</th><th>Tags</th><th>Slug</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- TinyMCE CDN -->
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
    import { ref as dbRef, set, get, child } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';
    import { ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js';
    
    // Utility functions
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDqdWux9ISGgG9dJIz_BuUTg2akiUYM14c",
      authDomain: "tracuuyte-7061a.firebaseapp.com",
      databaseURL: "https://tracuuyte-7061a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tracuuyte-7061a",
      storageBucket: "tracuuyte-7061a.firebasestorage.app",
      messagingSenderId: "837205769673",
      appId: "1:837205769673:web:45371c7b8f5efce4b1fc18",
      measurementId: "G-69TJE53D20"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const form = document.getElementById('drugForm');
    const preview = document.getElementById('preview');
    const imageFile = document.getElementById('imageFile');
    const imageUrl = document.getElementById('imageUrl');
    const tableBody = document.querySelector('#drugTable tbody');
    const bgImageInput = document.getElementById('bgImage');
    const headerTitle = document.querySelector('.header-content h2');

    // Rich editor area and section chooser UI
    const editorHost = document.createElement('section');
    editorHost.style.marginTop = '12px';
    editorHost.innerHTML = `
      <div class="row">
        <label>Ch·ªânh s·ª≠a m√¥ t·∫£ chi ti·∫øt b·∫±ng TinyMCE</label>
      </div>
      <textarea id="richEditor" rows="10"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button type="button" class="btn primary" id="applyEditorBtn">√Åp d·ª•ng m√¥ t·∫£</button>
      </div>
    `;
    form.insertBefore(editorHost, form.querySelector('button[type="submit"]').parentElement);

    // Tags management
    let selectedTags = [];
    const tagsContainer = document.getElementById('tagsContainer');
    const newTagInput = document.getElementById('newTagInput');
    const addTagBtn = document.getElementById('addTagBtn');

    function createTagElement(tag) {
      const tagEl = document.createElement('span');
      tagEl.className = 'tag';
      tagEl.style.cssText = 'background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 16px; font-size: 12px; display: flex; align-items: center; gap: 4px;';
      tagEl.innerHTML = `${tag} <span style="cursor: pointer; font-weight: bold;" onclick="removeTag('${tag}')">√ó</span>`;
      return tagEl;
    }

    function addTag(tag) {
      if (tag && !selectedTags.includes(tag)) {
        selectedTags.push(tag);
        tagsContainer.appendChild(createTagElement(tag));
        newTagInput.value = '';
      }
    }

    function removeTag(tag) {
      selectedTags = selectedTags.filter(t => t !== tag);
      renderTags();
    }

    function renderTags() {
      tagsContainer.innerHTML = '';
      selectedTags.forEach(tag => {
        tagsContainer.appendChild(createTagElement(tag));
      });
    }

    // Make removeTag globally accessible
    window.removeTag = removeTag;

    addTagBtn.addEventListener('click', () => {
      const tag = newTagInput.value.trim();
      if (tag) addTag(tag);
    });

    newTagInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const tag = newTagInput.value.trim();
        if (tag) addTag(tag);
      }
    });

    function loadDescriptionToEditor(){
      const content = form.description.value || '';
      tinymce.get('richEditor')?.setContent(content);
    }

    function applyEditorToDescription(){
      const html = tinymce.get('richEditor')?.getContent() || '';
      form.description.value = html;
      alert('ƒê√£ √°p d·ª•ng m√¥ t·∫£');
    }

    // Init TinyMCE
    tinymce.init({
      selector:'#richEditor',
      menubar:false,
      plugins:'lists link autolink image table code fullscreen',
      toolbar:'undo redo | bold italic underline | bullist numlist | link image | table | removeformat | code fullscreen',
      height: 320
    }).then(()=>{
      loadDescriptionToEditor();
    });

    editorHost.querySelector('#applyEditorBtn').addEventListener('click', applyEditorToDescription);

    const editingSlug = getQueryParam('slug');

    imageFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(f){ preview.src = URL.createObjectURL(f); preview.hidden = false; }
    });

    function toSlug(str){
      return str.toLowerCase().normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/ƒë/g,'d')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }

    async function uploadImageIfNeeded(file){
      if(!file) return null;
      const fileRef = sRef(storage, 'images/'+file.name);
      const snap = await uploadBytes(fileRef, file);
      return await getDownloadURL(snap.ref);
    }

    async function loadDrugList(){
      const snap = await get(child(dbRef(db), 'drug_names'));
      tableBody.innerHTML = '';
      if(!snap.exists()) return;
      Object.entries(snap.val()).forEach(([slug, v])=>{
        const tr = document.createElement('tr');
        const tagsDisplay = Array.isArray(v.tags) ? v.tags.join(', ') : '';
        tr.innerHTML = `<td><a href=\"./add_data.html?slug=${slug}\">${v.name}</a></td><td>${tagsDisplay}</td><td>${slug}</td>`;
        tr.addEventListener('click', (e)=>{
          if(e.target.closest('a')) return;
          window.location.href = `./add_data.html?slug=${slug}`;
        });
        tableBody.appendChild(tr);
      });
    }

    async function loadForEdit(slug){
      if(!slug) return;
      const snap = await get(child(dbRef(db), `drugs/${slug}`));
      if(!snap.exists()) return;
      const d = snap.val();
      form.name.value = d.name || '';
      
      // Load tags
      selectedTags = Array.isArray(d.tags) ? d.tags : [];
      renderTags();
      
      const desc = d.overview?.description || '';
      form.description.value = desc; // keep HTML for TinyMCE
      form.composition.value = d.overview?.composition || '';
      form.indication.value = Array.isArray(d.overview?.indication)? d.overview.indication.join('\n') : '';
      form.contraindication.value = Array.isArray(d.overview?.contraindication)? d.overview.contraindication.join('\n') : '';
      if(d.image){ preview.src = d.image; preview.hidden = false; imageUrl.value = d.image; }
      headerTitle && (headerTitle.textContent = 'üßæ Ch·ªânh s·ª≠a thu·ªëc');
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn && (submitBtn.textContent = 'üíæ C·∫≠p nh·∫≠t thu·ªëc');
      document.title = `Ch·ªânh s·ª≠a: ${d.name} - Admin`;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = form.name.value.trim();
      const slug = editingSlug || toSlug(name);
      
      // Ensure editor content saved back
      applyEditorToDescription();
      const description = form.description.value.trim();
      const composition = form.composition.value.trim();
      const indication = form.indication.value.split('\n').filter(Boolean);
      const contraindication = form.contraindication.value.split('\n').filter(Boolean);

      let img = imageUrl.value.trim();
      if(imageFile.files[0]) img = await uploadImageIfNeeded(imageFile.files[0]);

      if(!name){ alert('Vui l√≤ng nh·∫≠p t√™n thu·ªëc'); return; }
      if(selectedTags.length === 0){ alert('Vui l√≤ng th√™m √≠t nh·∫•t 1 tag'); return; }

      const drugData = {
        name, 
        tags: selectedTags,
        image: img||'',
        overview:{
          description: description || '',
          composition, indication, contraindication
        },
        keywords:[slug, name.toLowerCase(), ...selectedTags]
      };

      // Save tags to database for future search
      for(const tag of selectedTags) {
        await set(dbRef(db, `tags/${tag}`), true);
      }

      await set(dbRef(db, `drugs/${slug}`), drugData);
      await set(dbRef(db, `drug_names/${slug}`), { name, tags: selectedTags, image: img||'' });

      alert('‚úÖ ƒê√£ l∆∞u thu·ªëc: ' + name);
      form.reset(); 
      preview.hidden = true;
      selectedTags = [];
      renderTags();
      loadDrugList();
      
      // Redirect to index page to show updated data
      setTimeout(() => {
        window.location.href = './index.html?fromAdmin=true';
      }, 1000);
    });

    loadDrugList();
    if(editingSlug){
      loadForEdit(editingSlug);
    }
  </script>
</body>
</html>
